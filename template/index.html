<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UNIX Task Manager</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; display: flex; flex-direction: column; gap: 2rem; }
    input, button, textarea { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    .container { display: flex; gap: 2rem; }
    .column { flex: 1; border: 1px solid #ccc; padding: 1rem; }
    .task { border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
    .detail { background: #f9f9f9; padding: 1rem; }
    #top-bar { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <h1>UNIX Task Manager</h1>

  <!-- Login Box -->
  <div id="login-box">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <!-- Main UI -->
  <div id="main-box" style="display: none;">
    <div id="top-bar">
      <button onclick="logout()">Logout</button>
      <button onclick="loadTasks()">ðŸ”„ Refresh</button>
    </div>

    <div class="container">
      <!-- Create Task -->
      <div class="column">
        <h2>Create Task</h2>
        <input type="text" id="task-name" placeholder="Task name" />
        <textarea id="task-desc" placeholder="Description (optional)"></textarea>
        <input type="text" id="task-cmd" placeholder="Command to run" />
        <button onclick="createTask()">Create Task</button>
      </div>

      <!-- Task List -->
      <div class="column">
        <h2>Tasks</h2>
        <div id="task-list"></div>
      </div>

      <!-- Task Detail -->
      <div class="column">
        <h2>Details</h2>
        <div id="task-detail" class="detail">Select a task to see details</div>
      </div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem("token") || "";

    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("http://localhost:8000/userapi/login/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        if (!res.ok) throw new Error("Login failed");

        const data = await res.json();
        token = data.token;
        localStorage.setItem("token", token);

        showMain();
      } catch (err) {
        alert(err.message || "Login failed!");
      }
    }

    function logout() {
      token = "";
      localStorage.removeItem("token");
      document.getElementById("main-box").style.display = "none";
      document.getElementById("login-box").style.display = "block";
    }

    async function showMain() {
      document.getElementById("login-box").style.display = "none";
      document.getElementById("main-box").style.display = "block";
      await loadTasks();
    }

    async function loadTasks() {
      const res = await fetch("http://localhost:8000/taskapi/tasks/", {
        headers: { Authorization: `Token ${token}` },
      });

      if (!res.ok) {
        alert("Failed to fetch tasks.");
        return;
      }

      const tasks = await res.json();
      const list = document.getElementById("task-list");
      list.innerHTML = "";

      tasks.forEach(task => {
        const el = document.createElement("div");
        el.className = "task";
        el.textContent = `${task.name} [${task.status}]`;
        el.onclick = () => showTaskDetail(task);
        list.appendChild(el);
      });
    }

    async function createTask() {
      const name = document.getElementById("task-name").value;
      const description = document.getElementById("task-desc").value;
      const command = document.getElementById("task-cmd").value;

      if (!name || !command) {
        alert("Name and command are required!");
        return;
      }

      const res = await fetch("http://localhost:8000/taskapi/tasks/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Token ${token}`,
        },
        body: JSON.stringify({ name, description, command }),
      });

      if (!res.ok) {
        alert("Failed to create task.");
        return;
      }

      await loadTasks();
    }

    function showTaskDetail(task) {
      const box = document.getElementById("task-detail");
      box.innerHTML = `
        <h3>${task.name}</h3>
        <p><strong>Status:</strong> ${task.status}</p>
        <p><strong>Description:</strong><br/> ${task.description || "N/A"}</p>
        <p><strong>Command:</strong><br/> ${task.command}</p>
        <p><strong>Created:</strong> ${task.created_at}</p>
        <p><strong>Updated:</strong> ${task.updated_at}</p>
        ${task.completed_at ? `<p><strong>Completed:</strong> ${task.completed_at}</p>` : ""}
      `;
    }

    // Auto-login if token is already stored
    if (token) showMain();
  </script>
</body>
</html>
